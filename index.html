<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nearest-Color Image Mapper</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; background:#0f1115; color:#e5e7eb; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background:#151923; border:1px solid #1f2430; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label.btn { display:inline-block; padding:10px 14px; border:1px solid #2b3343; border-radius:12px; background:#181e2a; cursor:pointer; }
    input[type="file"]{ display:none; }
    button { padding:10px 14px; border:1px solid #2b3343; border-radius:12px; background:#1a2130; color:#e5e7eb; cursor:pointer; }
    button:hover{ background:#20293a; }
    .pill { padding:6px 10px; border:1px solid #2b3343; border-radius:999px; background:#111625; }
    canvas { max-width:100%; height:auto; image-rendering: pixelated; background:#0b0f17; border:1px solid #232a3a; border-radius:12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:8px; }
    .swatch { display:flex; align-items:center; gap:8px; border:1px solid #2b3343; border-radius:12px; padding:8px; background:#0f1422; }
    .box { width:28px; height:28px; border-radius:8px; border:1px solid #2b3343; }
    .muted{ color:#9aa4b2; font-size:12px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0e1422; border:1px solid #2b3343; padding:2px 6px; border-radius:6px; }
    details { border:1px dashed #2b3343; border-radius:12px; padding:8px 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Nearest-Color Image Mapper</h1>
    <p class="muted">Upload gambar ‚Üí sistem akan memetakan tiap pixel ke warna terdekat dari daftar yang sudah ditentukan.</p>

    <div class="card" style="margin-bottom:16px;">
      <div class="row">
        <label class="btn" for="file">üìÅ Upload Gambar</label>
        <input id="file" type="file" accept="image/*" />
        <button id="processBtn" disabled>‚ñ∂Ô∏è Proses & Quantize</button>
        <button id="downloadBtn" disabled>üíæ Download Hasil</button>
        <span class="pill">Klik kanvas untuk cek warna pada titik</span>
      </div>
      <div class="row" style="margin-top:8px; gap:16px;">
        <label><input type="checkbox" id="showOriginal" checked> Tampilkan gambar asli saat belum diproses</label>
        <label><input type="checkbox" id="fastMode" checked> Mode cepat (jarak Euclidean RGB)</label>
      </div>
    </div>

    <div class="row" style="align-items:flex-start;">
      <div style="flex:2; min-width:280px;">
        <canvas id="canvas" width="0" height="0"></canvas>
      </div>
      <div style="flex:1; min-width:260px;">
        <div class="card" style="margin-bottom:12px;">
          <div class="row" style="justify-content:space-between;">
            <div>
              <div>üìå Info Titik</div>
              <div id="pointInfo" class="muted">(x, y) ‚Äî klik pada kanvas</div>
            </div>
            <div>
              <div id="swatchBox" class="box" title="Preview"></div>
            </div>
          </div>
          <div class="muted" id="colorInfo">‚Äî</div>
        </div>
        <details>
          <summary>üé® Palet Warna yang Dipakai</summary>
          <div class="grid" id="palette"></div>
        </details>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <strong>Catatan:</strong>
      <ul>
        <li>Daftar warna mengikuti permintaan: grey, red, orange, yellow, green, aqua, blue, <em>purpel</em> (alias purple), white, black, brown, pastel*, dark*.</li>
        <li>"Dark" tanpa nama warna tidak dipakai (ambiguous).</li>
        <li>Mode cepat menggunakan jarak Euclidean RGB. Untuk akurasi lebih baik, matikan <span class="kbd">Mode cepat</span> untuk jarak perceptual sederhana (YCbCr-ish).</li>
      </ul>
    </div>
  </div>

  <script>
    // --- Warna target (nama -> [r,g,b]) ---
    const COLOR_LIST = {
      grey: [128,128,128],
      red: [255,0,0],
      orange: [255,165,0],
      yellow: [255,255,0],
      green: [0,128,0],
      aqua: [0,255,255],
      blue: [0,0,255],
      purpel: [128,0,128], // ejaan mengikuti input; alias ke purple
      purple: [128,0,128], // alias
      white: [255,255,255],
      black: [0,0,0],
      brown: [165,42,42],
      'pastel pink': [255,192,203],
      'pastel orange': [255,179,71],
      'pastel yellow': [253,253,150],
      'pastel green': [119,221,119],
      'pastel aqua': [174,238,238],
      'pastel blue': [174,198,207],
      'pastel purple': [179,158,181],
      'dark red': [139,0,0],
      'dark green': [0,100,0],
      'dark blue': [0,0,139],
      'dark aqua': [0,139,139],
      'dark yellow': [204,204,0],
      'dark purple': [48,25,52],
      'dark orange': [255,140,0],
      'dark brown': [101,67,33],
      'dark grey': [64,64,64]
      // "dark" (tanpa nama) diabaikan karena ambigu
    };

    const fileInput = document.getElementById('file');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const showOriginal = document.getElementById('showOriginal');
    const fastMode = document.getElementById('fastMode');
    const pointInfo = document.getElementById('pointInfo');
    const colorInfo = document.getElementById('colorInfo');
    const swatchBox = document.getElementById('swatchBox');

    let originalImg = new Image();
    let hasImage = false;

    // Populate palette UI
    (function renderPalette(){
      const palEl = document.getElementById('palette');
      const frag = document.createDocumentFragment();
      for (const [name, rgb] of Object.entries(COLOR_LIST)){
        const sw = document.createElement('div');
        sw.className = 'swatch';
        const box = document.createElement('div');
        box.className = 'box';
        box.style.background = rgbToHex(...rgb);
        const text = document.createElement('div');
        text.innerHTML = `<div>${name}</div><div class="muted">${rgbToHex(...rgb)}</div>`;
        sw.appendChild(box); sw.appendChild(text);
        frag.appendChild(sw);
      }
      palEl.appendChild(frag);
    })();

    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      originalImg.onload = ()=>{
        canvas.width = originalImg.width;
        canvas.height = originalImg.height;
        ctx.drawImage(originalImg, 0, 0);
        hasImage = true;
        processBtn.disabled = false;
        downloadBtn.disabled = true;
      };
      originalImg.src = url;
    });

    processBtn.addEventListener('click', ()=>{
      if (!hasImage) return;
      if (showOriginal.checked) ctx.drawImage(originalImg, 0, 0);
      quantizeToPalette();
      downloadBtn.disabled = false;
    });

    downloadBtn.addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'quantized.png';
      a.click();
    });

    // Click to probe a pixel
    canvas.addEventListener('click', (ev)=>{
      if (!hasImage) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((ev.clientX - rect.left) * (canvas.width / rect.width));
      const y = Math.floor((ev.clientY - rect.top) * (canvas.height / rect.height));
      const [r,g,b,a] = ctx.getImageData(x,y,1,1).data;
      const { name, rgb } = nearestColor(r,g,b);
      pointInfo.textContent = `(${x}, ${y})`;
      colorInfo.textContent = `${name}  ${rgbToHex(...rgb)}  ‚Äî  source RGB(${r},${g},${b})`;
      swatchBox.style.background = rgbToHex(...rgb);
    });

    // Core quantization
    function quantizeToPalette(){
      const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = img.data;
      // Precompute palette array for speed
      const entries = Object.entries(COLOR_LIST).map(([name, rgb])=>({name, rgb}));

      for (let i=0; i<data.length; i+=4){
        const r = data[i], g = data[i+1], b = data[i+2];
        const { rgb } = nearestColor(r,g,b, entries);
        data[i] = rgb[0]; data[i+1] = rgb[1]; data[i+2] = rgb[2]; // keep alpha
      }
      ctx.putImageData(img, 0, 0);
    }

    // Nearest color with two distance options
    function nearestColor(r,g,b, entries = null){
      entries ||= Object.entries(COLOR_LIST).map(([name, rgb])=>({name, rgb}));
      let best = { name: null, rgb: [0,0,0] };
      let bestD = Infinity;
      for (const e of entries){
        const d = fastMode.checked ? distRGB(r,g,b, ...e.rgb) : distPerceptual(r,g,b, ...e.rgb);
        if (d < bestD){ bestD = d; best = e; }
      }
      return best;
    }

    // Euclidean in RGB
    function distRGB(r1,g1,b1, r2,g2,b2){
      const dr=r1-r2, dg=g1-g2, db=b1-b2;
      return dr*dr + dg*dg + db*db;
    }

    // Lightweight perceptual distance (weighted YCbCr/BT.601 style)
    function distPerceptual(r1,g1,b1, r2,g2,b2){
      // Convert to luma/chroma approximations for a quick perceptual-ish metric
      const y1 = 0.299*r1 + 0.587*g1 + 0.114*b1;
      const cb1 = -0.168736*r1 - 0.331264*g1 + 0.5*b1 + 128;
      const cr1 = 0.5*r1 - 0.418688*g1 - 0.081312*b1 + 128;
      const y2 = 0.299*r2 + 0.587*g2 + 0.114*b2;
      const cb2 = -0.168736*r2 - 0.331264*g2 + 0.5*b2 + 128;
      const cr2 = 0.5*r2 - 0.418688*g2 - 0.081312*b2 + 128;
      const dy = y1-y2, dcb=cb1-cb2, dcr=cr1-cr2;
      // Weight luma higher than chroma
      return 2*dy*dy + dcb*dcb + dcr*dcr;
    }

    function rgbToHex(r,g,b){
      return '#' + [r,g,b].map(v=>{
        const s = v.toString(16).padStart(2,'0');
        return s;
      }).join('');
    }
  </script>
</body>
</html>
